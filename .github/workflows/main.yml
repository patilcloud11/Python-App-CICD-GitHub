name: Install Python & Deploy App using SSH

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo (needed for GitHub context)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # 3Ô∏è‚É£ Deploy on EC2
      - name: Install Python & Deploy App
        run: |
          ssh -i ~/.ssh/id_ed25519 \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            APP_DIR="${{ secrets.APP_DIR }}"

            echo "üîπ Updating system"
            sudo dnf update -y

            echo "üîπ Installing Python, pip and git"
            sudo dnf install -y python3 python3-pip git

            echo "üîπ Preparing application directory"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            if [ -d ".git" ]; then
              echo "üîπ Git repo exists ‚Üí pulling latest code"
              git pull origin main
            else
              echo "‚ö† Directory not a git repo ‚Üí cleaning & fresh clone"
              rm -rf ./*
              git clone https://github.com/${{ github.repository }} .
            fi

            echo "üîπ Installing dependencies"
            pip3 install --user -r requirements.txt

            echo "üîπ Restarting app"
            pkill -f app.py || true
            nohup python3 app.py > app.log 2>&1 &

            echo "‚úÖ Deployment successful"
          EOF
