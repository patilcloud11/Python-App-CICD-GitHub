name: Install Python & Deploy App using SSH_KEY

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup SSH using Flipkart.pem (SSH_KEY)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # 3Ô∏è‚É£ SSH into EC2 and do everything
      - name: Install Python, Clone Repo, Run App
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e

            echo "üîπ Updating system"
            sudo dnf update -y

            echo "üîπ Installing Python, pip and git"
            sudo dnf install -y python3 python3-pip git

            echo "üîπ Creating application directory"
            mkdir -p ${{ secrets.APP_DIR }}
            cd ${{ secrets.APP_DIR }}

            if [ ! -d ".git" ]; then
              echo "üîπ Cloning repository"
              git clone https://github.com/${{ github.repository }} .
            else
              echo "üîπ Pulling latest code"
              git pull origin main
            fi

            echo "üîπ Installing Python dependencies"
            pip3 install --user -r requirements.txt

            echo "üîπ Running Python application"
            pkill -f app.py || true
            nohup python3 app.py > app.log 2>&1 &

            echo "‚úÖ Deployment completed successfully"
          EOF
# test
